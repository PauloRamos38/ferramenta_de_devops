name: Deploy to Docker Registry

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  push-to-registry:
    name: Push Docker Image to Registry
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      if: github.event_name == 'push' && secrets.DOCKER_USERNAME != ''
      
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ secrets.DOCKER_USERNAME }}/flask-api
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest
      if: github.event_name == 'push' && secrets.DOCKER_USERNAME != ''
      
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: flask-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Test Docker image
      run: |
        docker build -t flask-api:test .
        docker run -d -p 5000:5000 --name test-api flask-api:test
        sleep 5
        
        echo "üß™ Testing health endpoints..."
        curl -fsS http://localhost:5000/health | grep -q '"status":"healthy"' && echo "‚úÖ Health check passed" || (echo "‚ùå Health check failed" && exit 1)
        
        echo "üìä Testing API endpoints..."
        curl -fsS -X GET http://localhost:5000/api/users | grep -q '"users"' && echo "‚úÖ GET /api/users passed" || (echo "‚ùå GET /api/users failed" && exit 1)
        curl -fsS -X GET http://localhost:5000/api/info | grep -q '"project"' && echo "‚úÖ GET /api/info passed" || (echo "‚ùå GET /api/info failed" && exit 1)
        
        docker stop test-api
        docker rm test-api
        
    - name: Push to Docker Hub
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      if: github.event_name == 'push' && secrets.DOCKER_USERNAME != ''
      
    - name: Image push summary
      run: |
        echo "üê≥ Docker Build Summary"
        echo "======================"
        echo "Repository: ${{ github.repository }}"
        echo "Commit SHA: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        echo ""
        echo "‚úÖ Build completed successfully!"
        if [ "${{ secrets.DOCKER_USERNAME }}" != "" ]; then
          echo "üì¶ Docker image pushed to Docker Hub"
          echo "üë§ Username: ${{ secrets.DOCKER_USERNAME }}"
        else
          echo "‚ÑπÔ∏è Note: To push to Docker Hub, configure Docker credentials in repository secrets"
        fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
      
    - name: Upload Trivy results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
      if: always()
      continue-on-error: true
      
    - name: Print security scan summary
      run: |
        echo "üîí Security Scan Results"
        echo "========================"
        echo "‚úÖ Scan completed"
        echo "Repository: ${{ github.repository }}"
